<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder | GIIS Clubs</title>
    <link rel="icon" type="image/png" href="/resources/1.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --primary-light: #eef2ff;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-main: #f8fafc;
            --bg-canvas: #ffffff;
            --bg-panel: #ffffff;
            --border: #e2e8f0;
            --border-focus: #6366f1;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --transition: all 0.2s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* ===== TOP BAR ===== */
        .top-bar {
            height: 56px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .top-bar-left { display: flex; align-items: center; gap: 16px; }
        .logo-section { display: flex; align-items: center; gap: 12px; }
        .logo { height: 32px; }

        .form-name-input {
            border: none;
            background: transparent;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: var(--radius-md);
            outline: none;
            transition: var(--transition);
            min-width: 200px;
        }

        .form-name-input:hover, .form-name-input:focus { background: var(--bg-main); }
        .form-name-input:focus { box-shadow: 0 0 0 2px var(--primary-light); }

        .autosave-status {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .autosave-status .dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
        }

        .top-bar-center {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-main);
            padding: 4px;
            border-radius: var(--radius-lg);
        }

        .view-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: var(--transition);
        }

        .view-tab:hover { color: var(--text-primary); }
        .view-tab.active { background: var(--bg-panel); color: var(--text-primary); box-shadow: var(--shadow-sm); }

        .top-bar-right { display: flex; align-items: center; gap: 8px; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            font-family: inherit;
        }

        .btn svg { width: 16px; height: 16px; }
        .btn-ghost { background: transparent; color: var(--text-secondary); }
        .btn-ghost:hover { background: var(--bg-main); color: var(--text-primary); }
        .btn-secondary { background: var(--bg-main); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }

        /* ===== MAIN LAYOUT ===== */
        .main-layout { display: flex; height: calc(100vh - 56px); margin-top: 56px; }

        /* ===== LEFT PANEL ===== */
        .left-panel {
            width: 280px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header { padding: 16px; border-bottom: 1px solid var(--border); }
        .panel-title { font-size: 13px; font-weight: 600; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px; }
        .panel-search { margin-top: 12px; position: relative; }

        .panel-search input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            outline: none;
            transition: var(--transition);
        }

        .panel-search input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .panel-search svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted); }

        .field-categories { flex: 1; overflow-y: auto; padding: 12px; }
        .field-category { margin-bottom: 20px; }
        .category-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; padding: 0 4px; }
        .field-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }

        .field-item {
            padding: 12px 10px;
            background: var(--bg-main);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            cursor: grab;
            text-align: center;
            transition: var(--transition);
        }

        .field-item:hover { border-color: var(--primary); background: var(--primary-light); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .field-item:active { cursor: grabbing; }

        .field-item-icon {
            width: 28px;
            height: 28px;
            margin: 0 auto 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-panel);
            border-radius: var(--radius-sm);
            color: var(--primary);
        }

        .field-item-icon svg { width: 16px; height: 16px; }
        .field-item-name { font-size: 11px; font-weight: 500; color: var(--text-secondary); }

        /* ===== CANVAS ===== */
        .canvas-area { flex: 1; background: var(--bg-main); overflow-y: auto; padding: 32px; display: flex; justify-content: center; }
        .canvas-wrapper { width: 100%; max-width: 720px; }

        .form-canvas {
            background: var(--bg-panel);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            min-height: 600px;
            overflow: hidden;
        }

        .canvas-header { padding: 32px 32px 24px; border-bottom: 1px solid var(--border); position: relative; }
        .canvas-header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, var(--primary), #8b5cf6, #ec4899); }

        .canvas-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            border: none;
            background: transparent;
            width: 100%;
            outline: none;
            margin-bottom: 8px;
        }

        .canvas-title::placeholder { color: var(--text-muted); }

        .canvas-description {
            font-size: 15px;
            color: var(--text-secondary);
            border: none;
            background: transparent;
            width: 100%;
            outline: none;
            resize: none;
            line-height: 1.6;
        }

        .canvas-description::placeholder { color: var(--text-muted); }
        .canvas-body { padding: 24px 32px 32px; }

        /* ===== FORM FIELDS ===== */
        .form-field {
            padding: 20px;
            border: 2px solid transparent;
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .form-field:hover { background: var(--bg-main); border-color: var(--border); }
        .form-field.selected { background: var(--primary-light); border-color: var(--primary); }

        .field-drag-handle {
            position: absolute;
            left: -32px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            opacity: 0;
            transition: var(--transition);
            cursor: grab;
        }

        .form-field:hover .field-drag-handle { opacity: 1; }
        .field-label { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 4px; }
        .field-required { color: var(--danger); }

        .field-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-panel);
            outline: none;
            transition: var(--transition);
        }

        .field-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .field-input::placeholder { color: var(--text-muted); }
        .field-helper { font-size: 12px; color: var(--text-muted); margin-top: 6px; }

        .field-actions {
            position: absolute;
            right: 12px;
            top: 12px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: var(--transition);
        }

        .form-field:hover .field-actions, .form-field.selected .field-actions { opacity: 1; }

        .field-action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: var(--bg-panel);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
        }

        .field-action-btn:hover { background: var(--bg-main); color: var(--text-primary); }
        .field-action-btn.delete:hover { background: #fef2f2; color: var(--danger); }
        .field-action-btn svg { width: 14px; height: 14px; }

        /* ===== DROP ZONE ===== */
        .drop-zone { border: 2px dashed var(--border); border-radius: var(--radius-lg); padding: 40px; text-align: center; color: var(--text-muted); transition: var(--transition); }
        .drop-zone.active { border-color: var(--primary); background: var(--primary-light); }
        .drop-zone-icon { width: 48px; height: 48px; margin: 0 auto 12px; background: var(--bg-main); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
        .drop-zone-icon svg { width: 24px; height: 24px; }
        .drop-zone-text { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
        .drop-zone-hint { font-size: 12px; }

        /* ===== RIGHT PANEL ===== */
        .right-panel { width: 340px; background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .properties-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .properties-title { font-size: 14px; font-weight: 600; }
        .properties-tabs { display: flex; gap: 4px; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg-main); }

        .prop-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .prop-tab:hover { color: var(--text-primary); }
        .prop-tab.active { background: var(--bg-panel); color: var(--text-primary); box-shadow: var(--shadow-sm); }

        .properties-content { flex: 1; overflow-y: auto; padding: 16px; }
        .prop-section { margin-bottom: 24px; }
        .prop-section-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .prop-group { margin-bottom: 16px; }
        .prop-label { font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px; display: block; }

        .prop-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            outline: none;
            transition: var(--transition);
            font-family: inherit;
        }

        .prop-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        .prop-select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 13px; outline: none; background: var(--bg-panel); cursor: pointer; }
        .prop-toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .prop-toggle-row:last-child { border-bottom: none; }
        .prop-toggle-label { font-size: 13px; color: var(--text-primary); }

        .toggle-switch { position: relative; width: 40px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; inset: 0; background: var(--border); border-radius: 22px; cursor: pointer; transition: var(--transition); }
        .toggle-slider::before { content: ''; position: absolute; width: 18px; height: 18px; left: 2px; top: 2px; background: #fff; border-radius: 50%; transition: var(--transition); box-shadow: var(--shadow-sm); }
        .toggle-switch input:checked + .toggle-slider { background: var(--primary); }
        .toggle-switch input:checked + .toggle-slider::before { transform: translateX(18px); }

        /* Color Picker */
        .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; margin-bottom: 12px; }
        .color-swatch { width: 100%; aspect-ratio: 1; border-radius: var(--radius-sm); cursor: pointer; border: 2px solid transparent; transition: var(--transition); }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: var(--text-primary); }
        .color-custom { display: flex; gap: 8px; }
        .color-custom input[type="color"] { width: 40px; height: 36px; border: none; border-radius: var(--radius-sm); cursor: pointer; }
        .color-custom input[type="text"] { flex: 1; }

        /* ===== BOTTOM BAR ===== */
        .bottom-bar { height: 40px; background: var(--bg-panel); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-size: 12px; color: var(--text-muted); position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; }
        .shortcuts { display: flex; gap: 16px; }
        .shortcut { display: flex; align-items: center; gap: 6px; }
        .shortcut kbd { padding: 2px 6px; background: var(--bg-main); border: 1px solid var(--border); border-radius: 4px; font-size: 11px; font-family: inherit; }

        /* ===== MODAL ===== */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: var(--transition); }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-panel); border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); max-width: 600px; width: 90%; max-height: 85vh; overflow: hidden; transform: scale(0.95) translateY(20px); transition: var(--transition); }
        .modal-overlay.show .modal { transform: scale(1) translateY(0); }
        .modal-header { padding: 24px; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .modal-header p { font-size: 14px; color: var(--text-secondary); }
        .modal-body { padding: 24px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

        /* ===== TEMPLATE GRID ===== */
        .template-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .template-card { border: 2px solid var(--border); border-radius: var(--radius-lg); padding: 20px; cursor: pointer; transition: var(--transition); text-align: center; }
        .template-card:hover { border-color: var(--primary); transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .template-card.selected { border-color: var(--primary); background: var(--primary-light); }
        .template-icon { width: 56px; height: 56px; margin: 0 auto 12px; background: linear-gradient(135deg, var(--primary), #8b5cf6); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; }
        .template-icon svg { width: 28px; height: 28px; color: #fff; }
        .template-name { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .template-desc { font-size: 12px; color: var(--text-muted); }

        /* ===== TOAST ===== */
        .toast { position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--text-primary); color: #fff; padding: 12px 24px; border-radius: var(--radius-lg); font-size: 14px; font-weight: 500; box-shadow: var(--shadow-xl); opacity: 0; visibility: hidden; transition: var(--transition); z-index: 1100; }
        .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        @media (max-width: 1200px) { .left-panel { width: 240px; } .right-panel { width: 300px; } }
        @media (max-width: 992px) { .left-panel, .right-panel { display: none; } }
    </style>
</head>
<body>
    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="top-bar-left">
            <div class="logo-section">
                <a href="/home"><img src="/resources/2.png" alt="GIIS Clubs" class="logo"></a>
            </div>
            <input type="text" class="form-name-input" id="formTitle" placeholder="Untitled Form" value="<%= typeof form !== 'undefined' && form ? form.title : '' %>">
            <div class="autosave-status" id="autosaveStatus">
                <span class="dot"></span>
                <span>All changes saved</span>
            </div>
        </div>
        <div class="top-bar-center">
            <button class="view-tab active" data-view="build">Build</button>
            <button class="view-tab" data-view="design">Design</button>
            <button class="view-tab" data-view="settings">Settings</button>
            <button class="view-tab" data-view="preview">Preview</button>
        </div>
        <div class="top-bar-right">
            <button class="btn btn-ghost" onclick="undo()" title="Undo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 00-9-9 9 9 0 00-6.36 2.64L3 13"/></svg></button>
            <button class="btn btn-ghost" onclick="redo()" title="Redo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 019-9 9 9 0 016.36 2.64L21 13"/></svg></button>
            <div style="width: 1px; height: 24px; background: var(--border); margin: 0 8px;"></div>
            <button class="btn btn-secondary" onclick="showShareModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg> Share</button>
            <button class="btn btn-primary" onclick="saveForm()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Publish</button>
        </div>
    </div>

    <div class="main-layout">
        <!-- LEFT PANEL -->
        <div class="left-panel">
            <div class="panel-header">
                <div class="panel-title">Form Elements</div>
                <div class="panel-search">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    <input type="text" placeholder="Search fields..." id="fieldSearch" oninput="filterFields(this.value)">
                </div>
            </div>
            <div class="field-categories" id="fieldCategories">
                <div class="field-category" data-category="input">
                    <div class="category-title">Input Fields</div>
                    <div class="field-grid">
                        <div class="field-item" draggable="true" data-type="text"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg></div><div class="field-item-name">Short Text</div></div>
                        <div class="field-item" draggable="true" data-type="textarea"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h6"/></svg></div><div class="field-item-name">Long Text</div></div>
                        <div class="field-item" draggable="true" data-type="email"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div><div class="field-item-name">Email</div></div>
                        <div class="field-item" draggable="true" data-type="number"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 9h4"/><path d="M5 15h4"/><path d="M19 9h-4"/><path d="M19 15h-4"/><path d="M7 5v14"/><path d="M17 5v14"/></svg></div><div class="field-item-name">Number</div></div>
                        <div class="field-item" draggable="true" data-type="phone"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg></div><div class="field-item-name">Phone</div></div>
                        <div class="field-item" draggable="true" data-type="url"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></div><div class="field-item-name">URL</div></div>
                    </div>
                </div>
                <div class="field-category" data-category="choice">
                    <div class="category-title">Choice Fields</div>
                    <div class="field-grid">
                        <div class="field-item" draggable="true" data-type="select"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></div><div class="field-item-name">Dropdown</div></div>
                        <div class="field-item" draggable="true" data-type="radio"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg></div><div class="field-item-name">Radio</div></div>
                        <div class="field-item" draggable="true" data-type="checkbox"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg></div><div class="field-item-name">Checkboxes</div></div>
                        <div class="field-item" draggable="true" data-type="toggle"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="5" width="22" height="14" rx="7"/><circle cx="16" cy="12" r="3"/></svg></div><div class="field-item-name">Toggle</div></div>
                    </div>
                </div>
                <div class="field-category" data-category="datetime">
                    <div class="category-title">Date & Time</div>
                    <div class="field-grid">
                        <div class="field-item" draggable="true" data-type="date"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div><div class="field-item-name">Date</div></div>
                        <div class="field-item" draggable="true" data-type="time"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div class="field-item-name">Time</div></div>
                    </div>
                </div>
                <div class="field-category" data-category="rating">
                    <div class="category-title">Rating & Scale</div>
                    <div class="field-grid">
                        <div class="field-item" draggable="true" data-type="rating"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div><div class="field-item-name">Star Rating</div></div>
                        <div class="field-item" draggable="true" data-type="scale"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/></svg></div><div class="field-item-name">Linear Scale</div></div>
                    </div>
                </div>
                <div class="field-category" data-category="media">
                    <div class="category-title">Media & Files</div>
                    <div class="field-grid">
                        <div class="field-item" draggable="true" data-type="file"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div><div class="field-item-name">File Upload</div></div>
                        <div class="field-item" draggable="true" data-type="signature"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></div><div class="field-item-name">Signature</div></div>
                    </div>
                </div>
                <div class="field-category" data-category="layout">
                    <div class="category-title">Layout</div>
                    <div class="field-grid">
                        <div class="field-item" draggable="true" data-type="section"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg></div><div class="field-item-name">Section</div></div>
                        <div class="field-item" draggable="true" data-type="pagebreak"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19h16"/><path d="M4 5h16"/><path d="M4 12h4"/><path d="M16 12h4"/></svg></div><div class="field-item-name">Page Break</div></div>
                        <div class="field-item" draggable="true" data-type="heading"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h8"/><path d="M4 18V6"/><path d="M12 18V6"/></svg></div><div class="field-item-name">Heading</div></div>
                        <div class="field-item" draggable="true" data-type="paragraph"><div class="field-item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/></svg></div><div class="field-item-name">Paragraph</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CANVAS -->
        <div class="canvas-area" id="canvasArea">
            <div class="canvas-wrapper">
                <div class="form-canvas" id="formCanvas">
                    <div class="canvas-header">
                        <input type="text" class="canvas-title" id="canvasTitle" placeholder="Untitled Form" value="<%= typeof form !== 'undefined' && form ? form.title : '' %>">
                        <textarea class="canvas-description" id="canvasDescription" placeholder="Add a description..." rows="2"><%= typeof form !== 'undefined' && form ? form.description : '' %></textarea>
                    </div>
                    <div class="canvas-body" id="canvasBody"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="right-panel" id="rightPanel">
            <div class="properties-header"><div class="properties-title" id="propertiesTitle">Form Settings</div></div>
            <div class="properties-tabs">
                <button class="prop-tab active" data-tab="general">General</button>
                <button class="prop-tab" data-tab="style">Style</button>
                <button class="prop-tab" data-tab="logic">Logic</button>
            </div>
            <div class="properties-content" id="propertiesContent">
                <div class="prop-section">
                    <div class="prop-section-title">Form Appearance</div>
                    <div class="prop-group">
                        <label class="prop-label">Theme</label>
                        <select class="prop-select" id="formTheme" onchange="updateFormSettings()">
                            <option value="default">Default</option>
                            <option value="modern">Modern</option>
                            <option value="minimal">Minimal</option>
                            <option value="bold">Bold</option>
                        </select>
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">Primary Color</label>
                        <div class="color-grid">
                            <div class="color-swatch selected" style="background: #6366f1;" data-color="#6366f1"></div>
                            <div class="color-swatch" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                            <div class="color-swatch" style="background: #ec4899;" data-color="#ec4899"></div>
                            <div class="color-swatch" style="background: #ef4444;" data-color="#ef4444"></div>
                            <div class="color-swatch" style="background: #f59e0b;" data-color="#f59e0b"></div>
                            <div class="color-swatch" style="background: #10b981;" data-color="#10b981"></div>
                            <div class="color-swatch" style="background: #06b6d4;" data-color="#06b6d4"></div>
                            <div class="color-swatch" style="background: #3b82f6;" data-color="#3b82f6"></div>
                        </div>
                        <div class="color-custom">
                            <input type="color" id="customColor" value="#6366f1">
                            <input type="text" class="prop-input" id="customColorHex" value="#6366f1">
                        </div>
                    </div>
                </div>
                <div class="prop-section">
                    <div class="prop-section-title">Form Behavior</div>
                    <div class="prop-toggle-row"><span class="prop-toggle-label">Show progress bar</span><label class="toggle-switch"><input type="checkbox" id="showProgress" checked onchange="updateFormSettings()"><span class="toggle-slider"></span></label></div>
                    <div class="prop-toggle-row"><span class="prop-toggle-label">Limit to one response</span><label class="toggle-switch"><input type="checkbox" id="limitResponses" onchange="updateFormSettings()"><span class="toggle-slider"></span></label></div>
                    <div class="prop-toggle-row"><span class="prop-toggle-label">Shuffle questions</span><label class="toggle-switch"><input type="checkbox" id="shuffleQuestions" onchange="updateFormSettings()"><span class="toggle-slider"></span></label></div>
                </div>
                <div class="prop-section">
                    <div class="prop-section-title">Submit Button</div>
                    <div class="prop-group"><label class="prop-label">Button Text</label><input type="text" class="prop-input" id="submitText" value="Submit" onchange="updateFormSettings()"></div>
                    <div class="prop-group"><label class="prop-label">Success Message</label><textarea class="prop-input" id="successMessage" rows="3" onchange="updateFormSettings()">Thank you for your response! üéâ</textarea></div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOTTOM BAR -->
    <div class="bottom-bar">
        <div class="shortcuts">
            <div class="shortcut"><kbd>‚åò</kbd><kbd>S</kbd> Save</div>
            <div class="shortcut"><kbd>‚åò</kbd><kbd>Z</kbd> Undo</div>
            <div class="shortcut"><kbd>‚åò</kbd><kbd>D</kbd> Duplicate</div>
            <div class="shortcut"><kbd>Del</kbd> Delete</div>
        </div>
        <div id="validationHints"><span style="color: var(--success);">‚úì Form is valid</span></div>
    </div>

    <!-- TEMPLATE MODAL -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal">
            <div class="modal-header"><h2>Choose a Template</h2><p>Start with a pre-built template or create from scratch</p></div>
            <div class="modal-body">
                <div class="template-grid">
                    <div class="template-card selected" data-template="blank"><div class="template-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg></div><div class="template-name">Blank Form</div><div class="template-desc">Start from scratch</div></div>
                    <div class="template-card" data-template="contact"><div class="template-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div><div class="template-name">Contact Form</div><div class="template-desc">Name, email, message</div></div>
                    <div class="template-card" data-template="event"><div class="template-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div><div class="template-name">Event Registration</div><div class="template-desc">Sign up for events</div></div>
                    <div class="template-card" data-template="feedback"><div class="template-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></div><div class="template-name">Feedback</div><div class="template-desc">Collect user feedback</div></div>
                    <div class="template-card" data-template="survey"><div class="template-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div><div class="template-name">Survey</div><div class="template-desc">Multi-question survey</div></div>
                    <div class="template-card" data-template="application"><div class="template-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg></div><div class="template-name">Application</div><div class="template-desc">Job or club application</div></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-ghost" onclick="closeTemplateModal()">Cancel</button><button class="btn btn-primary" onclick="useTemplate()">Use Template</button></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ===== STATE =====
        let formId = '<%= typeof form !== "undefined" && form ? form.id : "" %>';
        const clubName = '<%= typeof clubName !== "undefined" ? clubName : "" %>';
        let selectedFieldId = null;
        let history = [], historyIndex = -1;
        let autosaveTimer = null;

        let formData = {
            title: '',
            description: '',
            fields: [],
            settings: { theme: 'default', primaryColor: '#6366f1', showProgress: true, limitResponses: false, shuffleQuestions: false, submitText: 'Submit', successMessage: 'Thank you for your response! üéâ' }
        };

        const fieldTypes = {
            text: { label: 'Short Text', hasOptions: false },
            textarea: { label: 'Long Text', hasOptions: false },
            email: { label: 'Email', hasOptions: false },
            number: { label: 'Number', hasOptions: false },
            phone: { label: 'Phone', hasOptions: false },
            url: { label: 'URL', hasOptions: false },
            select: { label: 'Dropdown', hasOptions: true },
            radio: { label: 'Radio', hasOptions: true },
            checkbox: { label: 'Checkboxes', hasOptions: true },
            toggle: { label: 'Toggle', hasOptions: false },
            date: { label: 'Date', hasOptions: false },
            time: { label: 'Time', hasOptions: false },
            rating: { label: 'Star Rating', hasOptions: false },
            scale: { label: 'Linear Scale', hasOptions: false },
            file: { label: 'File Upload', hasOptions: false },
            signature: { label: 'Signature', hasOptions: false },
            section: { label: 'Section', isLayout: true },
            pagebreak: { label: 'Page Break', isLayout: true },
            heading: { label: 'Heading', isLayout: true },
            paragraph: { label: 'Paragraph', isLayout: true }
        };

        const templates = {
            blank: { title: 'Untitled Form', description: '', fields: [] },
            contact: { title: 'Contact Us', description: "We'd love to hear from you.", fields: [{ type: 'text', label: 'Full Name', required: true },{ type: 'email', label: 'Email', required: true },{ type: 'phone', label: 'Phone', required: false },{ type: 'textarea', label: 'Message', required: true }] },
            event: { title: 'Event Registration', description: 'Register for our upcoming event.', fields: [{ type: 'text', label: 'Full Name', required: true },{ type: 'email', label: 'Email', required: true },{ type: 'select', label: 'T-Shirt Size', options: ['S', 'M', 'L', 'XL'] },{ type: 'textarea', label: 'Any dietary restrictions?', required: false }] },
            feedback: { title: 'Feedback Form', description: 'We value your feedback!', fields: [{ type: 'rating', label: 'Overall Satisfaction', required: true },{ type: 'radio', label: 'Would you recommend us?', options: ['Definitely', 'Probably', 'Not sure', 'No'], required: true },{ type: 'textarea', label: 'Additional comments', required: false }] },
            survey: { title: 'Customer Survey', description: 'Help us improve our service.', fields: [{ type: 'radio', label: 'How often do you use our service?', options: ['Daily', 'Weekly', 'Monthly', 'Rarely'], required: true },{ type: 'scale', label: 'How satisfied are you?', required: true },{ type: 'checkbox', label: 'Features you use', options: ['Feature A', 'Feature B', 'Feature C'] },{ type: 'textarea', label: 'Suggestions', required: false }] },
            application: { title: 'Application Form', description: 'Complete all required fields.', fields: [{ type: 'text', label: 'Full Name', required: true },{ type: 'email', label: 'Email', required: true },{ type: 'phone', label: 'Phone', required: true },{ type: 'date', label: 'Date of Birth', required: false },{ type: 'textarea', label: 'Why are you interested?', required: true },{ type: 'file', label: 'Upload Resume', required: false }] }
        };

        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', function() {
            <% if (typeof form !== 'undefined' && form && form.fields) { %>
            try {
                formData.fields = <%- JSON.stringify(form.fields) %>.map(f => ({ ...f, id: f.id || generateId() }));
                formData.title = '<%= form.title || "" %>';
                formData.description = '<%= form.description || "" %>';
            } catch(e) {}
            <% } %>
            <% if (typeof form !== 'undefined' && form && form.settings) { %>
            try { formData.settings = { ...formData.settings, ...<%- JSON.stringify(form.settings) %> }; } catch(e) {}
            <% } %>

            if (!formId && formData.fields.length === 0) showTemplateModal();
            else renderCanvas();

            setupDragAndDrop();
            setupColorPicker();
            setupKeyboardShortcuts();
            syncTitles();
            setupPropertyTabs();
            saveHistory();
        });

        function generateId() { return 'f_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 9); }
        function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.textContent = msg; t.style.background = type === 'error' ? 'var(--danger)' : 'var(--text-primary)'; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }

        // ===== TEMPLATE MODAL =====
        function showTemplateModal() { document.getElementById('templateModal').classList.add('show'); }
        function closeTemplateModal() { document.getElementById('templateModal').classList.remove('show'); if (formData.fields.length === 0) addField('text'); renderCanvas(); }
        function useTemplate() {
            const sel = document.querySelector('.template-card.selected');
            if (!sel) return;
            const tmpl = templates[sel.dataset.template];
            formData.title = tmpl.title; formData.description = tmpl.description;
            formData.fields = tmpl.fields.map(f => ({ ...f, id: generateId() }));
            document.getElementById('formTitle').value = tmpl.title;
            document.getElementById('canvasTitle').value = tmpl.title;
            document.getElementById('canvasDescription').value = tmpl.description;
            closeTemplateModal(); saveHistory();
        }
        document.querySelectorAll('.template-card').forEach(c => c.addEventListener('click', function() { document.querySelectorAll('.template-card').forEach(x => x.classList.remove('selected')); this.classList.add('selected'); }));

        // ===== CANVAS =====
        function renderCanvas() {
            const body = document.getElementById('canvasBody');
            if (formData.fields.length === 0) {
                body.innerHTML = '<div class="drop-zone" id="mainDropZone"><div class="drop-zone-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div><div class="drop-zone-text">Drag fields here</div><div class="drop-zone-hint">or click a field type on the left</div></div>';
                return;
            }
            let html = '';
            formData.fields.forEach((f, i) => { html += renderField(f, i); });
            html += '<div class="drop-zone" style="padding:20px;margin-top:8px;"><div class="drop-zone-text" style="font-size:13px;">Drop here to add at end</div></div>';
            body.innerHTML = html;
            setupFieldEvents();
        }

        function renderField(field, index) {
            const type = fieldTypes[field.type] || { label: field.type };
            const isSel = field.id === selectedFieldId;
            let preview = '';
            switch(field.type) {
                case 'text': case 'email': case 'phone': case 'url': case 'number':
                    preview = `<input type="text" class="field-input" placeholder="${field.placeholder || 'Your answer'}" disabled>`; break;
                case 'textarea':
                    preview = `<textarea class="field-input" placeholder="${field.placeholder || 'Your answer'}" rows="3" disabled></textarea>`; break;
                case 'select':
                    preview = `<select class="field-input" disabled><option>Select an option</option></select>`; break;
                case 'radio':
                    preview = (field.options || ['Option 1', 'Option 2']).map(o => `<label style="display:flex;align-items:center;gap:8px;padding:8px 0;"><input type="radio" disabled> ${o}</label>`).join(''); break;
                case 'checkbox':
                    preview = (field.options || ['Option 1', 'Option 2']).map(o => `<label style="display:flex;align-items:center;gap:8px;padding:8px 0;"><input type="checkbox" disabled> ${o}</label>`).join(''); break;
                case 'date': preview = `<input type="date" class="field-input" disabled>`; break;
                case 'time': preview = `<input type="time" class="field-input" disabled>`; break;
                case 'rating': preview = `<div style="font-size:24px;color:var(--text-muted);">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>`; break;
                case 'scale': preview = `<div style="display:flex;gap:8px;align-items:center;"><span style="font-size:12px;">1</span><input type="range" style="flex:1;" disabled><span style="font-size:12px;">10</span></div>`; break;
                case 'file': preview = `<div style="border:2px dashed var(--border);padding:20px;text-align:center;border-radius:var(--radius-md);color:var(--text-muted);">üìé Click or drag to upload</div>`; break;
                case 'signature': preview = `<div style="border:1px solid var(--border);padding:30px;text-align:center;border-radius:var(--radius-md);color:var(--text-muted);">‚úçÔ∏è Click to sign</div>`; break;
                case 'toggle': preview = `<label class="toggle-switch" style="pointer-events:none;"><input type="checkbox"><span class="toggle-slider"></span></label>`; break;
                case 'heading': preview = `<h3 style="font-size:18px;font-weight:600;">${field.label || 'Heading'}</h3>`; break;
                case 'paragraph': preview = `<p style="color:var(--text-secondary);">${field.content || 'Paragraph text...'}</p>`; break;
                default: preview = `<input type="text" class="field-input" placeholder="..." disabled>`;
            }
            return `<div class="form-field ${isSel ? 'selected' : ''}" data-id="${field.id}" data-index="${index}" draggable="true">
                <div class="field-drag-handle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg></div>
                <div class="field-actions">
                    <button class="field-action-btn" onclick="duplicateField('${field.id}')" title="Duplicate"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button>
                    <button class="field-action-btn delete" onclick="deleteField('${field.id}')" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
                </div>
                ${field.type !== 'heading' && field.type !== 'paragraph' ? `<label class="field-label">${field.label || 'Untitled Question'}${field.required ? '<span class="field-required">*</span>' : ''}</label>` : ''}
                ${preview}
                ${field.helperText ? `<div class="field-helper">${field.helperText}</div>` : ''}
            </div>`;
        }

        function setupFieldEvents() {
            document.querySelectorAll('.form-field').forEach(f => {
                f.addEventListener('click', function(e) {
                    if (e.target.closest('.field-action-btn')) return;
                    selectField(this.dataset.id);
                });
            });
        }

        // ===== FIELD OPS =====
        function addField(type, afterIndex = null) {
            const newField = { id: generateId(), type, label: fieldTypes[type]?.label || 'Question', required: false, placeholder: '', helperText: '' };
            if (fieldTypes[type]?.hasOptions) newField.options = ['Option 1', 'Option 2', 'Option 3'];
            if (afterIndex !== null && afterIndex >= 0) formData.fields.splice(afterIndex + 1, 0, newField);
            else formData.fields.push(newField);
            renderCanvas(); selectField(newField.id); saveHistory(); triggerAutosave();
        }

        function selectField(id) { selectedFieldId = id; renderCanvas(); renderFieldProperties(id); }

        function duplicateField(id) {
            const idx = formData.fields.findIndex(f => f.id === id);
            if (idx === -1) return;
            const dup = { ...JSON.parse(JSON.stringify(formData.fields[idx])), id: generateId() };
            formData.fields.splice(idx + 1, 0, dup);
            renderCanvas(); selectField(dup.id); saveHistory(); triggerAutosave(); showToast('Field duplicated');
        }

        function deleteField(id) {
            const idx = formData.fields.findIndex(f => f.id === id);
            if (idx === -1) return;
            formData.fields.splice(idx, 1);
            selectedFieldId = null;
            renderCanvas(); renderFormProperties(); saveHistory(); triggerAutosave(); showToast('Field deleted');
        }

        // ===== PROPERTIES =====
        function renderFieldProperties(id) {
            const field = formData.fields.find(f => f.id === id);
            if (!field) return;
            document.getElementById('propertiesTitle').textContent = fieldTypes[field.type]?.label || 'Field';
            const content = document.getElementById('propertiesContent');
            content.innerHTML = `
                <div class="prop-section"><div class="prop-section-title">Basic</div>
                    <div class="prop-group"><label class="prop-label">Label</label><input type="text" class="prop-input" value="${field.label || ''}" onchange="updateField('${id}','label',this.value)"></div>
                    <div class="prop-group"><label class="prop-label">Placeholder</label><input type="text" class="prop-input" value="${field.placeholder || ''}" onchange="updateField('${id}','placeholder',this.value)"></div>
                    <div class="prop-group"><label class="prop-label">Helper Text</label><input type="text" class="prop-input" value="${field.helperText || ''}" onchange="updateField('${id}','helperText',this.value)"></div>
                </div>
                <div class="prop-section"><div class="prop-section-title">Validation</div>
                    <div class="prop-toggle-row"><span class="prop-toggle-label">Required</span><label class="toggle-switch"><input type="checkbox" ${field.required ? 'checked' : ''} onchange="updateField('${id}','required',this.checked)"><span class="toggle-slider"></span></label></div>
                </div>
                ${fieldTypes[field.type]?.hasOptions ? `
                <div class="prop-section"><div class="prop-section-title">Options</div>
                    <div id="optionsList">${(field.options || []).map((opt, i) => `<div style="display:flex;gap:8px;margin-bottom:8px;"><input type="text" class="prop-input" value="${opt}" onchange="updateOption('${id}',${i},this.value)" style="flex:1;"><button class="btn btn-ghost" onclick="removeOption('${id}',${i})" style="padding:8px;">‚úï</button></div>`).join('')}</div>
                    <button class="btn btn-secondary" onclick="addOption('${id}')" style="width:100%;margin-top:8px;">+ Add Option</button>
                </div>` : ''}
            `;
        }

        function renderFormProperties() {
            document.getElementById('propertiesTitle').textContent = 'Form Settings';
            const content = document.getElementById('propertiesContent');
            content.innerHTML = `
                <div class="prop-section">
                    <div class="prop-section-title">Quick Actions</div>
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Click on a field in the canvas to edit its properties, or drag fields from the left panel to add them.</p>
                    <button class="btn btn-secondary" onclick="showTemplateModal()" style="width:100%;justify-content:center;margin-bottom:8px;">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                        Use Template
                    </button>
                </div>
                <div class="prop-section">
                    <div class="prop-section-title">Form Info</div>
                    <div style="font-size:13px;color:var(--text-secondary);">
                        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
                            <span>Fields</span>
                            <span style="font-weight:600;color:var(--text-primary);">${formData.fields.length}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
                            <span>Required</span>
                            <span style="font-weight:600;color:var(--text-primary);">${formData.fields.filter(f => f.required).length}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:8px 0;">
                            <span>Status</span>
                            <span style="font-weight:600;color:${formId ? 'var(--success)' : 'var(--warning)'};">${formId ? 'Published' : 'Draft'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateField(id, prop, val) { const f = formData.fields.find(x => x.id === id); if (f) { f[prop] = val; renderCanvas(); triggerAutosave(); } }
        function addOption(id) { const f = formData.fields.find(x => x.id === id); if (!f) return; if (!f.options) f.options = []; f.options.push(`Option ${f.options.length + 1}`); renderFieldProperties(id); renderCanvas(); triggerAutosave(); }
        function removeOption(id, idx) { const f = formData.fields.find(x => x.id === id); if (!f || !f.options) return; f.options.splice(idx, 1); renderFieldProperties(id); renderCanvas(); triggerAutosave(); }
        function updateOption(id, idx, val) { const f = formData.fields.find(x => x.id === id); if (f && f.options) { f.options[idx] = val; renderCanvas(); triggerAutosave(); } }
        function updateFormSettings() { formData.settings.theme = document.getElementById('formTheme').value; formData.settings.showProgress = document.getElementById('showProgress').checked; formData.settings.limitResponses = document.getElementById('limitResponses').checked; formData.settings.shuffleQuestions = document.getElementById('shuffleQuestions').checked; formData.settings.submitText = document.getElementById('submitText').value; formData.settings.successMessage = document.getElementById('successMessage').value; triggerAutosave(); }

        // ===== DRAG & DROP =====
        function setupDragAndDrop() {
            document.querySelectorAll('.field-item').forEach(item => {
                item.addEventListener('dragstart', e => { e.dataTransfer.setData('fieldType', item.dataset.type); });
                item.addEventListener('click', () => addField(item.dataset.type));
            });
            const area = document.getElementById('canvasArea');
            area.addEventListener('dragover', e => { e.preventDefault(); });
            area.addEventListener('drop', e => { e.preventDefault(); const type = e.dataTransfer.getData('fieldType'); if (type) addField(type); });
        }

        // ===== PROPERTY TABS =====
        function setupPropertyTabs() { document.querySelectorAll('.prop-tab').forEach(t => t.addEventListener('click', function() { document.querySelectorAll('.prop-tab').forEach(x => x.classList.remove('active')); this.classList.add('active'); })); }

        // ===== COLOR PICKER =====
        function setupColorPicker() {
            document.querySelectorAll('.color-swatch').forEach(s => s.addEventListener('click', function() {
                document.querySelectorAll('.color-swatch').forEach(x => x.classList.remove('selected'));
                this.classList.add('selected');
                const c = this.dataset.color;
                const customColor = document.getElementById('customColor') || document.getElementById('customColorDesign');
                const customColorHex = document.getElementById('customColorHex') || document.getElementById('customColorHexDesign');
                if (customColor) customColor.value = c;
                if (customColorHex) customColorHex.value = c;
                formData.settings.primaryColor = c;
                document.documentElement.style.setProperty('--primary', c);
                triggerAutosave();
            }));
            const customColor = document.getElementById('customColor') || document.getElementById('customColorDesign');
            if (customColor) {
                customColor.addEventListener('input', function() {
                    document.querySelectorAll('.color-swatch').forEach(x => x.classList.remove('selected'));
                    const customColorHex = document.getElementById('customColorHex') || document.getElementById('customColorHexDesign');
                    if (customColorHex) customColorHex.value = this.value;
                    formData.settings.primaryColor = this.value;
                    document.documentElement.style.setProperty('--primary', this.value);
                    triggerAutosave();
                });
            }
        }

        // ===== KEYBOARD =====
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', e => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveForm(); }
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) { e.preventDefault(); undo(); }
                if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) { e.preventDefault(); redo(); }
                if (e.key === 'Delete' && selectedFieldId) deleteField(selectedFieldId);
                if ((e.ctrlKey || e.metaKey) && e.key === 'd' && selectedFieldId) { e.preventDefault(); duplicateField(selectedFieldId); }
            });
        }

        // ===== TITLE SYNC =====
        function syncTitles() {
            const ft = document.getElementById('formTitle'), ct = document.getElementById('canvasTitle');
            ft.addEventListener('input', function() { ct.value = this.value; formData.title = this.value; triggerAutosave(); });
            ct.addEventListener('input', function() { ft.value = this.value; formData.title = this.value; triggerAutosave(); });
            document.getElementById('canvasDescription').addEventListener('input', function() { formData.description = this.value; triggerAutosave(); });
        }

        // ===== HISTORY =====
        function saveHistory() { if (historyIndex < history.length - 1) history = history.slice(0, historyIndex + 1); history.push(JSON.stringify(formData)); if (history.length > 50) history.shift(); historyIndex = history.length - 1; }
        function undo() { if (historyIndex > 0) { historyIndex--; formData = JSON.parse(history[historyIndex]); renderCanvas(); showToast('Undo'); } }
        function redo() { if (historyIndex < history.length - 1) { historyIndex++; formData = JSON.parse(history[historyIndex]); renderCanvas(); showToast('Redo'); } }

        // ===== AUTOSAVE =====
        let isSaving = false;
        let pendingSave = false;

        function triggerAutosave() {
            const s = document.getElementById('autosaveStatus');
            s.innerHTML = '<span class="dot" style="background:var(--warning);"></span><span>Saving...</span>';
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(() => performAutosave(), 1500);
        }

        async function performAutosave() {
            if (isSaving) { pendingSave = true; return; }
            isSaving = true;
            const s = document.getElementById('autosaveStatus');
            
            const title = document.getElementById('formTitle').value.trim() || 'Untitled Form';
            const desc = document.getElementById('canvasDescription').value.trim();
            const payload = { id: formId || null, title, description: desc, fields: formData.fields, settings: formData.settings, clubName };
            
            try {
                const res = await fetch('/forms/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const r = await res.json();
                if (r.success) {
                    if (!formId && r.formId) {
                        formId = r.formId;
                        if (window.history.replaceState) window.history.replaceState({}, '', `/forms/edit/${formId}`);
                    }
                    s.innerHTML = '<span class="dot"></span><span>All changes saved</span>';
                } else {
                    s.innerHTML = '<span class="dot" style="background:var(--danger);"></span><span>Error saving</span>';
                }
            } catch (e) {
                s.innerHTML = '<span class="dot" style="background:var(--danger);"></span><span>Error saving</span>';
            }
            
            isSaving = false;
            if (pendingSave) { pendingSave = false; triggerAutosave(); }
        }

        // ===== SAVE (Publish) =====
        async function saveForm() {
            const s = document.getElementById('autosaveStatus');
            s.innerHTML = '<span class="dot" style="background:var(--warning);"></span><span>Publishing...</span>';
            
            const title = document.getElementById('formTitle').value.trim() || 'Untitled Form';
            const desc = document.getElementById('canvasDescription').value.trim();
            const payload = { id: formId || null, title, description: desc, fields: formData.fields, settings: formData.settings, clubName };
            try {
                const res = await fetch('/forms/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const r = await res.json();
                if (r.success) {
                    formId = r.formId;
                    showToast('Form published! üéâ');
                    s.innerHTML = '<span class="dot"></span><span>All changes saved</span>';
                    if (window.history.replaceState) window.history.replaceState({}, '', `/forms/edit/${formId}`);
                }
                else showToast(r.error || 'Error saving', 'error');
            } catch (e) { showToast('Error saving form', 'error'); }
        }

        function previewForm() {
            // Save first, then preview
            performAutosave().then(() => {
                if (formId) window.open(`/forms/view/${formId}`, '_blank');
                else showToast('Add some fields first', 'error');
            });
        }
        
        function showShareModal() {
            if (!formId) { showToast('Add some fields first', 'error'); return; }
            const url = `${window.location.origin}/forms/view/${formId}`;
            navigator.clipboard.writeText(url);
            showToast('Link copied! üìã');
        }

        function filterFields(q) {
            q = q.toLowerCase();
            document.querySelectorAll('.field-item').forEach(item => {
                const name = item.querySelector('.field-item-name').textContent.toLowerCase();
                item.style.display = name.includes(q) ? '' : 'none';
            });
        }

        // ===== VIEW TABS =====
        let currentView = 'build';
        
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
            
            const leftPanel = document.querySelector('.left-panel');
            const rightPanel = document.querySelector('.right-panel');
            const canvasArea = document.getElementById('canvasArea');
            
            // Reset panels
            leftPanel.style.display = '';
            rightPanel.style.display = '';
            
            if (view === 'build') {
                renderFormProperties();
                document.getElementById('propertiesTitle').textContent = selectedFieldId ? 'Field Properties' : 'Form Settings';
            } else if (view === 'design') {
                selectedFieldId = null;
                renderCanvas();
                renderDesignPanel();
            } else if (view === 'settings') {
                selectedFieldId = null;
                renderCanvas();
                renderSettingsPanel();
            } else if (view === 'preview') {
                previewForm();
                // Stay on build view
                switchView('build');
                return;
            }
        }

        function renderDesignPanel() {
            document.getElementById('propertiesTitle').textContent = 'Design';
            const content = document.getElementById('propertiesContent');
            content.innerHTML = `
                <div class="prop-section">
                    <div class="prop-section-title">Theme Color</div>
                    <div class="color-grid">
                        <div class="color-swatch ${formData.settings.primaryColor === '#6366f1' ? 'selected' : ''}" style="background: #6366f1;" data-color="#6366f1"></div>
                        <div class="color-swatch ${formData.settings.primaryColor === '#8b5cf6' ? 'selected' : ''}" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-swatch ${formData.settings.primaryColor === '#ec4899' ? 'selected' : ''}" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-swatch ${formData.settings.primaryColor === '#ef4444' ? 'selected' : ''}" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-swatch ${formData.settings.primaryColor === '#f59e0b' ? 'selected' : ''}" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-swatch ${formData.settings.primaryColor === '#10b981' ? 'selected' : ''}" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-swatch ${formData.settings.primaryColor === '#06b6d4' ? 'selected' : ''}" style="background: #06b6d4;" data-color="#06b6d4"></div>
                        <div class="color-swatch ${formData.settings.primaryColor === '#3b82f6' ? 'selected' : ''}" style="background: #3b82f6;" data-color="#3b82f6"></div>
                    </div>
                    <div class="color-custom" style="margin-top:12px;">
                        <input type="color" id="customColorDesign" value="${formData.settings.primaryColor || '#6366f1'}" onchange="updatePrimaryColor(this.value)">
                        <input type="text" class="prop-input" id="customColorHexDesign" value="${formData.settings.primaryColor || '#6366f1'}" onchange="updatePrimaryColor(this.value)">
                    </div>
                </div>
                <div class="prop-section">
                    <div class="prop-section-title">Form Style</div>
                    <div class="prop-group">
                        <label class="prop-label">Corner Radius</label>
                        <select class="prop-select" onchange="formData.settings.borderRadius = this.value; triggerAutosave();">
                            <option value="rounded" ${formData.settings.borderRadius === 'rounded' ? 'selected' : ''}>Rounded</option>
                            <option value="sharp" ${formData.settings.borderRadius === 'sharp' ? 'selected' : ''}>Sharp</option>
                            <option value="pill" ${formData.settings.borderRadius === 'pill' ? 'selected' : ''}>Pill</option>
                        </select>
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">Field Spacing</label>
                        <select class="prop-select" onchange="formData.settings.spacing = this.value; triggerAutosave();">
                            <option value="compact" ${formData.settings.spacing === 'compact' ? 'selected' : ''}>Compact</option>
                            <option value="normal" ${formData.settings.spacing === 'normal' || !formData.settings.spacing ? 'selected' : ''}>Normal</option>
                            <option value="relaxed" ${formData.settings.spacing === 'relaxed' ? 'selected' : ''}>Relaxed</option>
                        </select>
                    </div>
                </div>
            `;
            setupColorPicker();
        }

        function renderSettingsPanel() {
            document.getElementById('propertiesTitle').textContent = 'Settings';
            const content = document.getElementById('propertiesContent');
            content.innerHTML = `
                <div class="prop-section">
                    <div class="prop-section-title">Form Behavior</div>
                    <div class="prop-toggle-row">
                        <span class="prop-toggle-label">Show progress bar</span>
                        <label class="toggle-switch"><input type="checkbox" ${formData.settings.showProgress !== false ? 'checked' : ''} onchange="formData.settings.showProgress = this.checked; triggerAutosave();"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="prop-toggle-row">
                        <span class="prop-toggle-label">Limit to one response</span>
                        <label class="toggle-switch"><input type="checkbox" ${formData.settings.limitResponses ? 'checked' : ''} onchange="formData.settings.limitResponses = this.checked; triggerAutosave();"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="prop-toggle-row">
                        <span class="prop-toggle-label">Shuffle questions</span>
                        <label class="toggle-switch"><input type="checkbox" ${formData.settings.shuffleQuestions ? 'checked' : ''} onchange="formData.settings.shuffleQuestions = this.checked; triggerAutosave();"><span class="toggle-slider"></span></label>
                    </div>
                </div>
                <div class="prop-section">
                    <div class="prop-section-title">Submit Button</div>
                    <div class="prop-group">
                        <label class="prop-label">Button Text</label>
                        <input type="text" class="prop-input" value="${formData.settings.submitText || 'Submit'}" onchange="formData.settings.submitText = this.value; triggerAutosave();">
                    </div>
                </div>
                <div class="prop-section">
                    <div class="prop-section-title">Confirmation</div>
                    <div class="prop-group">
                        <label class="prop-label">Success Message</label>
                        <textarea class="prop-input" rows="3" onchange="formData.settings.successMessage = this.value; triggerAutosave();">${formData.settings.successMessage || 'Thank you for your response! üéâ'}</textarea>
                    </div>
                </div>
            `;
        }

        function updatePrimaryColor(color) {
            formData.settings.primaryColor = color;
            document.documentElement.style.setProperty('--primary', color);
            triggerAutosave();
            if (currentView === 'design') renderDesignPanel();
        }

        document.querySelectorAll('.view-tab').forEach(t => t.addEventListener('click', function() {
            switchView(this.dataset.view);
        }));
    </script>
</body>
</html>
